CREATE OR REPLACE TRIGGER SICAS_OC.TRG_REQUISITOS_COBERTURAS
  BEFORE INSERT OR UPDATE OR DELETE ON REQUISITOS_COBERTURAS
  FOR EACH ROW 
DECLARE
    vl_Texto    VARCHAR2(4000);
    vl_ErrorN   NUMBER;
    vl_ErrorC   VARCHAR2(4000);

BEGIN
  /*TRIGGER PARA MONITOREO DE LA TABLA REQUISITOS_COBERTURAS
    FECHA CREACIÓN: 29/02/2024
    MODIFICO: LUIS ARGENIS REYNOSO ALVAREZ
    INDICE UNICO: CODCIA, CODEMPRESA, IDTIPOSEG, PLANCOB, CODCOBERT, CODREQUISITO   
  */

  IF DELETING THEN 
      vl_Texto := TO_CHAR(:OLD.CODCIA)||' - '||TO_CHAR(:OLD.CODEMPRESA)||' - '||TO_CHAR(:OLD.IDTIPOSEG)||' - '||TO_CHAR(:OLD.PLANCOB)||' - '||TO_CHAR(:OLD.CODCOBERT)||' - '||
                  TO_CHAR(:OLD.CODREQUISITO)||' - '||TO_CHAR(:OLD.REQUERIDO)||' - '||TO_CHAR(:OLD.ORDENEXPEDIENTE)||' - '||TO_CHAR(:OLD.ORDENPDF)||' - '||TO_CHAR(:OLD.CANTIDAD)||' - '||
                  TO_CHAR(:OLD.USRINSERT)||' - '||TO_CHAR(:OLD.FECHAINSERT)||' - '||TO_CHAR(:OLD.USRMODIF)||' - '||TO_CHAR(:OLD.FECHAMODIF);
      
      OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'SE ELIMINA TODO EL REGISTRO', vl_Texto, 'REGISTRO ELIMINADO', 'DELETE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
  END IF;

  IF INSERTING THEN 
      vl_Texto := TO_CHAR(:NEW.CODCIA)||' - '||TO_CHAR(:NEW.CODEMPRESA)||' - '||TO_CHAR(:NEW.IDTIPOSEG)||' - '||TO_CHAR(:NEW.PLANCOB)||' - '||TO_CHAR(:NEW.CODCOBERT)||' - '||
                  TO_CHAR(:NEW.CODREQUISITO)||' - '||TO_CHAR(:NEW.REQUERIDO)||' - '||TO_CHAR(:NEW.ORDENEXPEDIENTE)||' - '||TO_CHAR(:NEW.ORDENPDF)||' - '||TO_CHAR(:NEW.CANTIDAD)||' - '||
                  TO_CHAR(:NEW.USRINSERT)||' - '||TO_CHAR(:NEW.FECHAINSERT)||' - '||TO_CHAR(:NEW.USRMODIF)||' - '||TO_CHAR(:NEW.FECHAMODIF);

    OC_LOG_CONF_FACT_ELECT.INSERTA(:NEW.CODCIA, 'REQUISITOS_COBERTURAS', 'SE AGREGA NUEVO REGISTRO', vl_Texto, 'NUEVO REGISTRO', 'INSERT',:NEW.IDTIPOSEG||' - '||:NEW.PLANCOB||' - '||:NEW.CODCOBERT||' - '||:NEW.CODREQUISITO);
  END IF;

  IF UPDATING THEN 
    IF (:NEW.CODCIA <> :OLD.CODCIA) THEN
      OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'IDTIPOSEG',  TO_CHAR(:OLD.CODCIA),  TO_CHAR(:NEW.CODCIA), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.CODEMPRESA <> :OLD.CODEMPRESA) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'CODEMPRESA',  TO_CHAR(:OLD.CODEMPRESA),  TO_CHAR(:NEW.CODEMPRESA), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    
    IF (:NEW.IDTIPOSEG <> :OLD.IDTIPOSEG) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'IDTIPOSEG', TO_CHAR(:OLD.IDTIPOSEG), TO_CHAR(:NEW.IDTIPOSEG), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.PLANCOB <> :OLD.PLANCOB) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'PLANCOB', TO_CHAR(:OLD.PLANCOB), TO_CHAR(:NEW.PLANCOB), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.CODCOBERT <> :OLD.CODCOBERT) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'CODCOBERT',  TO_CHAR(:OLD.CODCOBERT),  TO_CHAR(:NEW.CODCOBERT), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.CODREQUISITO <> :OLD.CODREQUISITO) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'CODREQUISITO',  TO_CHAR(:OLD.CODREQUISITO),  TO_CHAR(:NEW.CODREQUISITO), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.REQUERIDO <> :OLD.REQUERIDO) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'ESTADO_PLAN', TO_CHAR(:OLD.REQUERIDO), TO_CHAR(:NEW.REQUERIDO), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.ORDENEXPEDIENTE <> :OLD.ORDENEXPEDIENTE) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'ORDENEXPEDIENTE', TO_CHAR(:OLD.ORDENEXPEDIENTE), TO_CHAR(:NEW.ORDENEXPEDIENTE), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.ORDENPDF <> :OLD.ORDENPDF) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'ORDENPDF', TO_CHAR(:OLD.ORDENPDF), TO_CHAR(:NEW.ORDENPDF), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.CANTIDAD <> :OLD.CANTIDAD) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'CANTIDAD', TO_CHAR(:OLD.CANTIDAD), TO_CHAR(:NEW.CANTIDAD), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.USRINSERT <> :OLD.USRINSERT) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'USRINSERT', TO_CHAR(:OLD.USRINSERT), TO_CHAR(:NEW.USRINSERT), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.FECHAINSERT <> :OLD.FECHAINSERT) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'FECHAINSERT', TO_CHAR(:OLD.FECHAINSERT), TO_CHAR(:NEW.FECHAINSERT), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.USRMODIF <> :OLD.USRMODIF) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'USRMODIF', TO_CHAR(:OLD.USRMODIF), TO_CHAR(:NEW.USRMODIF), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
    IF (:NEW.FECHAMODIF <> :OLD.FECHAMODIF) THEN
       OC_LOG_CONF_FACT_ELECT.INSERTA(:OLD.CODCIA, 'REQUISITOS_COBERTURAS', 'FECHAMODIF', TO_CHAR(:OLD.FECHAMODIF), TO_CHAR(:NEW.FECHAMODIF), 'UPDATE',:OLD.IDTIPOSEG||' - '||:OLD.PLANCOB||' - '||:OLD.CODCOBERT||' - '||:OLD.CODREQUISITO);
    END IF;
  END IF;    

EXCEPTION
    WHEN OTHERS THEN 
      vl_ErrorN := SQLCODE;
      vl_ErrorC := 'Error con el disparador de REQUISITOS_COBERTURAS, Contacte al administrador. '||SQLERRM;
      raise_application_error( -20000,vl_ErrorC);
END;
/

CREATE OR REPLACE PUBLIC SYNONYM TRG_REQUISITOS_COBERTURAS FOR SICAS_OC.TRG_REQUISITOS_COBERTURAS;
/